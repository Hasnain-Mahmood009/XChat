<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#4a90e2">

    <title>XChat</title>
    <style>
        /* Global Reset and Premium Font */
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap');
        
        /* üõ†Ô∏è FIX 1: Set HTML and Body to full height to ensure 100vh works properly */
        html, body {
            height: 100%; /* Ensure full height from the root */
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', sans-serif;
        }

        /* Color Palette: 
           --dark-navy: #1C2833; 
           --gold-accent: #FFC300; 
           --off-white: #F4F6F7; */

        body {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: #F4F6F7; /* Light background */
            overflow: hidden;
        }

        /* --- DESKTOP Layout (Default: 900px max-width) --- */
        .chat-container {
            width: 95%;
            max-width: 900px; /* Desktop width */
            height: 90vh; /* Desktop height */
            margin: auto; /* Centering */
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 15px 40px rgba(28, 40, 51, 0.2);
            background: #FFFFFF;
            display: flex;
            flex-direction: column;
        }

        /* --- Auth/Login Area (Desktop View) --- */
        .auth-area {
            display: flex;
            justify-content: center;
            align-items: center;
            flex-grow: 1;
            padding: 40px;
        }

        .auth-card {
            width: 100%;
            max-width: 350px;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            background: #FFFFFF;
            border: 1px solid #EAECEE;
            margin: 0 15px;
        }
        
        .auth-card h3 {
            font-size: 20px;
            color: #1C2833;
            margin-bottom: 20px;
            border-left: 3px solid #FFC300;
            padding-left: 10px;
        }

        .auth-card input {
            width: 100%;
            padding: 12px;
            margin-bottom: 15px;
            border: 1px solid #D5DBDB;
            border-radius: 6px;
            outline: none;
            background: #F4F6F7;
        }
        
        .auth-card button {
            width: 100%;
            padding: 12px;
            background: #1C2833; 
            color: #FFFFFF;
            border: none;
            border-radius: 6px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s;
        }

        .auth-card button:hover {
            background: #FFC300; 
            color: #1C2833;
        }

        /* --- Chat Area (Common/Desktop) --- */
        .chat-area {
            display: none; 
            flex-direction: column;
            flex-grow: 1;
            overflow: hidden;
        }

        .chat-header {
            padding: 15px 25px;
            border-bottom: 3px solid #FFC300; 
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #1C2833; 
            color: #F4F6F7;
        }

        .chat-header h4 {
            font-weight: 600;
            color: #FFC300;
            font-size: 18px; 
        }

        .user-info {
            font-size: 14px;
            color: #AAB7B8;
            display: block; 
        }

        .chat-header .user-info #userEmail {
             display: none;
        }
        
        .logout-button {
            padding: 8px 15px;
            background: #FFC300;
            color: #1C2833;
            border: none;
            border-radius: 5px;
            font-weight: 600;
            cursor: pointer;
            transition: opacity 0.3s;
            font-size: 12px;
        }

        .logout-button:hover {
            opacity: 0.8;
        }


        /* --- Message Display Area --- */
        #messages {
            flex-grow: 1;
            padding: 20px 25px;
            overflow-y: auto;
            background: #F4F6F7; 
        }

        #messages::-webkit-scrollbar {
            width: 8px;
        }

        #messages::-webkit-scrollbar-thumb {
            background-color: #D5DBDB;
            border-radius: 4px;
        }
        
        /* Message Styling */
        .message-line {
            display: flex;
            margin-bottom: 10px;
            max-width: 80%;
        }

        .message-line.sent {
            margin-left: auto;
            justify-content: flex-end;
            text-align: right;
        }

        .message-line.received {
            margin-right: auto;
            justify-content: flex-start;
            text-align: left;
        }
        
        .message-content {
            padding: 10px 15px;
            border-radius: 18px;
            font-size: 14px;
            line-height: 1.4;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
            position: relative;
        }
        
        .message-line.sent .message-content {
            background: #FFC300; 
            color: #1C2833;
            border-bottom-right-radius: 5px;
        }

        .message-line.received .message-content {
            background: #FFFFFF; 
            color: #1C2833;
            border: 1px solid #EAECEE;
            border-bottom-left-radius: 5px;
        }

        .message-sender {
            display: block;
            font-weight: 600;
            font-size: 12px;
            margin-bottom: 2px;
            opacity: 0.7;
        }

        .message-line.sent .message-sender {
            color: #1C2833; 
        }

        .message-line.received .message-sender {
            color: #1C2833; 
        }


        /* --- Chat Input Area --- */
        .chat-input {
            padding: 15px 25px;
            border-top: 1px solid #EAECEE;
            display: flex;
            align-items: center;
            background: #FFFFFF;
        }

        .chat-input input {
            flex-grow: 1;
            padding: 12px 18px;
            border: 1px solid #D5DBDB;
            border-radius: 25px;
            font-size: 15px;
            outline: none;
            margin-right: 15px;
            background: #F4F6F7;
            transition: border-color 0.3s;
        }

        .chat-input input:focus {
            border-color: #FFC300;
        }

        .send-button {
            background: #1C2833; 
            color: #FFFFFF;
            border: none;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 18px;
            cursor: pointer;
            transition: background 0.3s, transform 0.1s;
        }

        .send-button:hover {
            background: #FFC300;
            color: #1C2833;
        }

        .send-button:active {
            transform: scale(0.95);
        }

        /* ======================================= */
        /* --- MOBILE RESPONSIVE STYLES (max-width: 600px) --- */
        /* ======================================= */
        @media (max-width: 600px) {
            
            /* üõ†Ô∏è FIX 2: Main Chat Container Height Fix */
            .chat-container {
                width: 100vw;
                max-width: 100vw;
                /* FIX APPLIED: height ko 100vh se badal kar 100% kiya. 
                   Kyunki html, body 100% hain, ab yeh available screen height lega. */
                ;
                margin-top: 0;
                border-radius: 0; 
                box-shadow: none; 
                height: 100%;
                /* Optional: Agar ab bhi scroll ho, toh yeh line use kar sakte hain. 
                   height: 100dvh; 
                   dvh (Dynamic Viewport Height) modern browsers mein sabse achha fix hai. 
                   Lekin 100% kaafi hona chahiye.
                */
                /* height: 100vh; */
            }

            /* üõ†Ô∏è FIX 3: Add flex-grow to messages to ensure it takes remaining space */
            #messages {
                flex-grow: 1; /* This is already present, ensuring it takes all available middle space */
                /* Adjust padding */
                padding: 15px; ;
            }

            /* Auth Area Stacked */
            .auth-area {
                flex-direction: column; 
                padding: 20px;
                overflow-y: auto;
            }

            /* Auth Cards Styling */
            .auth-card {
                max-width: 100%; 
                margin: 15px 0; 
                padding: 25px;
            }

            /* Chat Header Compact */
            .chat-header {
                padding: 10px 15px; 
            }

            .chat-header h4 {
                font-size: 16px;
                margin-right: 10px;
            }

            .user-info {
                font-size: 12px;
                display: none; 
            }

            .logout-button {
                padding: 6px 12px; 
                font-size: 11px;
            }

            /* Messages Area */
            .message-line {
                max-width: 90%; 
            }

            /* Chat Input Compact */
            .chat-input {
                padding: 10px 15px; 
            }

            .chat-input input {
                padding: 10px 15px; 
                margin-right: 10px;
                width: 30%;
            }

            .send-button {
                width: 40px; 
                height: 40px;
                font-size: 16px;
            }
        }
    </style>
</head>
<body>

    <div class="chat-container">
        
        <div id="authArea" class="auth-area">
            <div class="auth-card">
                <h3>Login to Join Chat üí¨</h3>
                <input type="email" id="loginEmail" placeholder="Email Address">
                <input type="password" id="loginPassword" placeholder="Password">
                <button onclick="login()">Sign In</button>
            </div>
            
            <div class="auth-card">
                <h3>New User Signup ‚úçÔ∏è</h3>
                <input type="email" id="signupEmail" placeholder="Email Address">
                <input type="password" id="signupPassword" placeholder="Password">
                <button onclick="signup()">Sign Up</button>
            </div>
        </div>

        <div id="chatArea" class="chat-area">
            
            <div class="chat-header">
                <h4 id="roomName">Global Chatroom (XChat)</h4>
                <div class="user-info">
                    Logged in as: <span id="userEmail" style="font-weight: 600; color: #FFFFFF;">Guest</span>
                </div>
                <button class="logout-button" onclick="logout()">Logout</button>
            </div>

            <div id="messages">
                </div>

            <div class="chat-input">
                <input type="text" id="messageInput" placeholder="Type your message here..." onkeypress="if(event.key === 'Enter') sendMessage()">
                <button class="send-button" onclick="sendMessage()">
                    &#10148; 
                </button>
            </div>

        </div>

    </div>

  <script type="module">
  // Firebase v12 Module
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
  import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
  import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";
  import { getMessaging, getToken, onMessage } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-messaging.js";

  // Firebase Config
  const firebaseConfig = {
    apiKey: "AIzaSyA5daFUKCFePdkZ1Zn1YmhAk39bHu0A6UM",
    authDomain: "newchatapp-e7614.firebaseapp.com",
    projectId: "newchatapp-e7614",
    storageBucket: "newchatapp-e7614.firebasestorage.app",
    messagingSenderId: "122269204382",
    appId: "1:122269204382:web:feac24c3b6f2f2ca9b608f"
  };

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  const messaging = getMessaging(app);

  // HTML Elements
  const authArea = document.getElementById('authArea');
  const chatArea = document.getElementById('chatArea');
  const messagesDiv = document.getElementById('messages');
  const userEmailSpan = document.getElementById('userEmail');
  const messageInput = document.getElementById('messageInput');

  // Signup
  window.signup = function() {
    const email = document.getElementById("signupEmail").value;
    const password = document.getElementById("signupPassword").value;
    if(password.length < 6){ alert("Password should be at least 6 characters."); return; }
    createUserWithEmailAndPassword(auth,email,password)
      .catch(error => alert("Signup Error: " + error.message));
  }

  // Login
  window.login = function() {
    const email = document.getElementById("loginEmail").value;
    const password = document.getElementById("loginPassword").value;
    signInWithEmailAndPassword(auth,email,password)
      .catch(error => alert("Login Error: " + error.message));
  }

  // Logout
  window.logout = function() { auth.signOut(); }

  // Auth state change
  auth.onAuthStateChanged(user => {
    if(user){
      authArea.style.display = 'none';
      chatArea.style.display = 'flex';
      userEmailSpan.textContent = user.email.split('@')[0];
      listenMessages(user);
    } else {
      authArea.style.display = 'flex';
      chatArea.style.display = 'none';
      userEmailSpan.textContent = 'Guest';
      messagesDiv.innerHTML = '';
    }
  });

  // Send message
  window.sendMessage = async function(){
    const text = messageInput.value.trim();
    if(!text) return;
    const user = auth.currentUser;
    if(!user){ alert("Please log in to send a message."); messageInput.value=''; return; }
    try{
      await addDoc(collection(db,'messages'),{
        text,
        sender: user.email,
        createdAt: serverTimestamp()
      });
      messageInput.value='';
    } catch(error){ alert("Error sending message: " + error.message); }
  }

  // Listen messages
  function listenMessages(currentUser){
    const q = query(collection(db,'messages'),orderBy('createdAt','asc'));
    onSnapshot(q,snapshot=>{
      messagesDiv.innerHTML='';
      snapshot.forEach(doc=>{
        const m = doc.data();
        const line = document.createElement('div');
        line.classList.add('message-line');
        const content = document.createElement('div');
        content.classList.add('message-content');
        const sender = document.createElement('span');
        sender.classList.add('message-sender');
        const textNode = document.createTextNode(m.text);
        if(m.sender === currentUser.email){ line.classList.add('sent'); sender.textContent='You'; }
        else{ line.classList.add('received'); sender.textContent=m.sender ? m.sender.split('@')[0] : 'Unknown'; }
        content.appendChild(sender);
        content.appendChild(textNode);
        line.appendChild(content);
        messagesDiv.appendChild(line);
      });
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    });
  }

  // Firebase Messaging
  async function initFCM(){
    try {
      // Register service worker
      const swRegistration = await navigator.serviceWorker.register('sw.js');
      console.log("Service Worker Registered!");

      // Get token
      const token = await getToken(messaging, { vapidKey: "BHSZPDYXRREioLWrA3rVtyya85rKlW5_fg3PaGaWV5mKFoJtNjGvFzyVCVDfNyEQmFMvML83patB44EdZDcK10s", serviceWorkerRegistration: swRegistration });
      console.log("Device Token:", token);
    } catch(err){
      console.log("FCM Error:", err);
    }
  }

  initFCM();

  // Foreground messages
  onMessage(messaging, payload => console.log("Foreground Message:", payload));

</script>



</body>
</html>